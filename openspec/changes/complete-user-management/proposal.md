# Proposal: Complete User Management

## Summary

为系统添加完整的用户管理功能，包括用户列表查询（支持分页和搜索）、管理员创建用户、删除用户、启用/禁用用户状态切换。现有系统已具备用户注册、登录和角色管理功能，本次变更专注于管理员视角的用户管理操作。

## Why

当前系统缺乏完整的用户管理能力，管理员无法：

- 查看和浏览用户列表
- 搜索特定用户
- 通过管理后台创建用户
- 删除不需要的用户账户
- 管理用户的启用/禁用状态

这些功能对于企业级应用的用户管理至关重要。

## What

### 新增功能

1. **用户列表查询**
   - 支持分页查询用户列表
   - 支持按邮箱、姓名搜索
   - 支持按启用状态筛选
   - 支持按创建时间排序

2. **管理员创建用户**
   - 允许管理员直接创建用户（无需邮箱验证码）
   - 支持设置初始密码
   - 支持分配初始角色

3. **删除用户**
   - 支持软删除用户账户（添加 `deletedAt` 字段）
   - 删除时级联删除相关用户角色关系
   - 支持批量删除用户
   - 只有超级管理员可以删除其他管理员用户

4. **启用/禁用用户**
   - 切换用户账户的启用/禁用状态
   - 禁用的用户无法登录系统
   - 支持批量启用/禁用用户

### 影响范围

- **新增API端点**：
  - `GET /api/users` - 查询用户列表
  - `POST /api/users/create` - 管理员创建用户
  - `DELETE /api/users` - 删除用户（支持单个或批量）
  - `PATCH /api/users/toggle-status` - 切换用户状态（支持单个或批量）

- **新增DTO**：
  - `QueryUsersDto` - 用户列表查询参数
  - `CreateUserDto` - 管理员创建用户参数
  - `UserListResponseDto` - 用户列表响应

- **修改的服务**：
  - `UserService` - 添加列表查询、创建、删除、状态切换方法

## Impact Analysis

### 兼容性

- 新增API端点不影响现有功能
- 现有用户注册、登录流程保持不变
- 角色管理功能保持兼容

### 安全性

- 所有用户管理API需要管理员权限
- 密码处理遵循现有安全规范（bcrypt加密）
- 删除用户需要额外验证（防止误删）

### 性能

- 用户列表查询使用数据库分页，避免内存溢出
- 添加必要的索引以优化查询性能
- 删除操作使用软删除，保留数据用于审计

### 数据库

- 用户实体已有 `isActive` 字段，无需修改
- 添加 `deletedAt` 字段用于软删除
- 为搜索字段（email, name）添加复合索引

## Design Decisions

1. **软删除策略**：采用软删除，在用户实体添加 `deletedAt` 字段
2. **超级管理员定义**：
   - 创建系统内置角色 "SUPER_ADMIN" (code: 'SUPER_ADMIN', name: '超级管理员')
   - 拥有此角色的用户即为超级管理员
   - 超级管理员可以通过用户管理接口创建
3. **删除权限**：
   - 超级管理员可以删除任何用户（包括其他管理员）
   - 普通管理员不能删除其他管理员用户
   - 任何人都不能删除自己
4. **批量操作**：删除和状态切换接口同时支持单个和批量操作
5. **审计日志**：暂不实现，后续可扩展

## Implementation Notes

- 需要在 UserService 中添加 `isSuperAdmin` 方法，用于判断用户是否为超级管理员
- 需要在 UserService 中添加 `isAdmin` 方法，用于判断用户是否为管理员角色
- 创建系统初始化脚本，创建默认的超级管理员角色

## Related Changes

- Role管理功能（已实现）
- Permission管理功能（已实现）
- Auth认证功能（已实现）

## Success Criteria

- 管理员能够查看分页的用户列表
- 管理员能够通过邮箱或姓名搜索用户
- 管理员能够创建新用户（无需邮箱验证码）
- 管理员能够删除用户账户
- 管理员能够切换用户的启用/禁用状态
- 禁用的用户无法登录系统
- 所有操作都有适当的权限验证和错误处理
- API文档完整且可用

## Alternative Approaches

1. **仅实现硬删除**：不采用软删除，数据直接删除。优点是简单，缺点是无法恢复和审计。
2. **使用现有的注册接口**：复用用户注册API创建用户，但需要绕过邮箱验证。缺点是接口语义不清晰。
3. **扩展现有查询接口**：在现有接口基础上添加参数，但会违反单一职责原则。

**推荐方案**：采用新的专用API端点，配合软删除策略。
