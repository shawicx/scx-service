name: Deploy to Aliyun ECS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  IMAGE_NAME: scx-service
  ECS_HOST: ${{ secrets.ECS_HOST }}
  ECS_USER: ${{ secrets.ECS_USER }}
  ECS_SSH_KEY: ${{ secrets.ECS_SSH_KEY }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:latest .

      - name: Save Docker image
        run: |
          docker save ${{ env.IMAGE_NAME }}:latest | gzip > scx-service-image.tar.gz

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ECS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.ECS_HOST }} >> ~/.ssh/known_hosts

      - name: Create project directory on ECS
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.ECS_USER }}@${{ env.ECS_HOST }} << 'ENDSSH'
            mkdir -p /opt/scx-service
          ENDSSH

      - name: Copy Docker image to ECS
        run: |
          scp -i ~/.ssh/deploy_key scx-service-image.tar.gz ${{ env.ECS_USER }}@${{ env.ECS_HOST }}:/opt/scx-service/

      - name: Copy docker-compose.prod.yml to ECS
        run: |
          scp -i ~/.ssh/deploy_key docker-compose.prod.yml ${{ env.ECS_USER }}@${{ env.ECS_HOST }}:/opt/scx-service/

      - name: Deploy to ECS
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.ECS_USER }}@${{ env.ECS_HOST }} << 'ENDSSH'
            set -e
            cd /opt/scx-service
            # 生成 .env 文件（关键步骤，之前缺少）
            cat > .env <<'EOF'
          # 应用配置
          NODE_ENV=production
          PORT=${{ secrets.PORT || '3000' }}

          # 数据库配置 (PostgreSQL)
          DB_HOST=postgres
          DB_PORT=5432
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_DATABASE=${{ secrets.DB_DATABASE || 'scx-service' }}

          # Redis 配置
          REDIS_HOST=redis
          REDIS_PORT=6379
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD || '' }}
          REDIS_DB=0

          # JWT 配置（可选）
          JWT_SECRET=${{ secrets.JWT_SECRET || '' }}
          JWT_EXPIRES_IN=7d

          # Swagger 配置
          SWAGGER_ENABLED=${{ secrets.SWAGGER_ENABLED || 'true' }}
          SWAGGER_TITLE=${{ secrets.SWAGGER_TITLE || 'SCX Service API' }}
          SWAGGER_DESCRIPTION=${{ secrets.SWAGGER_DESCRIPTION || 'SCX Service API Documentation' }}
          SWAGGER_VERSION=${{ secrets.SWAGGER_VERSION || '1.0' }}
          SWAGGER_PATH=${{ secrets.SWAGGER_PATH || 'api/docs' }}

          # 邮件配置
          MAIL_HOST=${{ secrets.MAIL_HOST }}
          MAIL_PORT=${{ secrets.MAIL_PORT }}
          MAIL_SECURE=${{ secrets.MAIL_SECURE }}
          MAIL_USER=${{ secrets.MAIL_USER }}
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          MAIL_FROM=${{ secrets.MAIL_FROM }}

          # AI 模块配置
          AI_DEFAULT_PROVIDER=${{ secrets.AI_DEFAULT_PROVIDER || 'copilot' }}
          AI_TIMEOUT=${{ secrets.AI_TIMEOUT || '30000' }}
          AI_CACHE_TTL=${{ secrets.AI_CACHE_TTL || '3600' }}
          AI_ENABLE_CACHE=${{ secrets.AI_ENABLE_CACHE || 'true' }}
          AI_MAX_TOKENS_LIMIT=${{ secrets.AI_MAX_TOKENS_LIMIT || '4096' }}

          # AI 监控配置
          AI_LOG_REQUESTS=${{ secrets.AI_LOG_REQUESTS || 'true' }}
          AI_LOG_RESPONSES=${{ secrets.AI_LOG_RESPONSES || 'false' }}
          AI_LOG_TOKENS=${{ secrets.AI_LOG_TOKENS || 'true' }}

          # GitHub Copilot 配置
          COPILOT_BASE_URL=${{ secrets.COPILOT_BASE_URL || '' }}
          COPILOT_MODEL=${{ secrets.COPILOT_MODEL || 'gpt-4' }}
          COPILOT_MODEL=${{ secrets.COPILOT_MODEL }}

          # GLM (智谱AI) 配置
          GLM_BASE_URL=${{ secrets.GLM_BASE_URL || '' }}
          GLM_MODEL=${{ secrets.GLM_MODEL || 'glm-4' }}

          # Qwen (阿里通义千问) 配置
          QWEN_BASE_URL=${{ secrets.QWEN_BASE_URL || '' }}
          QWEN_MODEL=${{ secrets.QWEN_MODEL || 'qwen-turbo' }}
          EOF

          # 验证 .env 生成成功
          echo "=== Checking .env file ==="
          ls -la .env
          cat .env | head -20

          # 加载镜像并启动
          docker load < scx-service-image.tar.gz
          docker compose --env-file .env -f docker-compose.prod.yml up -d --force-recreate
          rm -f scx-service-image.tar.gz
          docker image prune -f

          # 检查服务状态
          sleep 10
          echo "=== Service status ==="
          docker ps -a | grep scx-service
          docker logs scx-service-postgres --tail 30
          docker logs scx-service-redis --tail 30
          docker logs scx-service-app --tail 30
          ENDSSH

      # - name: Health check
      #   run: |
      #     sleep 15
      #     for i in {1..30}; do
      #       if curl -f -s -o /dev/null http://${{ env.ECS_HOST }}:3000/api/health || \
      #          curl -f -s -o /dev/null http://${{ env.ECS_HOST }}:3000/api/docs; then
      #         echo "✓ Deployment successful!"
      #         exit 0
      #       fi
      #       echo "Waiting for service to be ready... ($i/30)"
      #       sleep 3
      #     done
      #     echo "✗ Health check failed"
      #     exit 1
